# コート配置アルゴリズム仕様書

**日付**: 2026-02-07
**対象**: `src/lib/algorithm.ts` の `assignCourts` / `selectBestFour`

---

## 概要

「配置」ボタン押下時に、待機メンバーから4人を選出してコートに配置するアルゴリズム。
以下の制約と優先度を考慮して、最適な4人の組み合わせを選ぶ。

---

## 配置フロー（個別コート配置）

```
配置ボタン押下
│
▼ Step 1: グループ分け
│  全アクティブプレイヤー（コート中含む）を対象にグループ分け
│  → 待機者だけでなくコート中の人も含めることでグループが安定
│
▼ Step 2: eligible フィルタ（ハード制約のみ）
│  対象コートに prob=0 のグループ → 除外
│  gamesPlayed=0 の人も含め、prob>0 なら全員候補に残す
│
▼ Step 3: コート適性ペナルティ計算
│  各候補に対して random() × (1 - courtProb) のペナルティを付与
│  gamesPlayed=0 の人はペナルティなし（最優先を保証）
│
▼ Step 4: selectBestFour（C(N,4) 組み合わせ探索）
│  全候補から4人の組み合わせを全探索
│  有効な組の中で「優先スコア+ペナルティ」合計が最小の組を選出
│
▼ Step 5: formTeams（チーム編成）
│  選出された4人から最適なペア分けを決定
│
▼ コートに配置
```

---

## Step 1: グループ分け

### 入力
- 全アクティブプレイヤー（`allPlayers`: コートでプレイ中も含む）
- 試合履歴（`matchHistory`）

### 3コート用: upper / middle / lower の3分割

1. `buildInitialOrder`: レート降順で並べる（未設定はmiddle位置に挿入）
2. `applyStreakSwaps`: 2連勝→1つ上と交代、2連敗→1つ下と交代
3. 3等分（端数はmiddleに）

### 2コート用: upper / lower の2分割

1. 同様に序列構築
2. 2等分（端数はlowerに）

### 1コート
グループ分けなし。

---

## Step 2: eligible フィルタ

**prob=0 のハード制約のみ適用。ランダム間引きは行わない。**

### 3コート確率テーブル

```
         C1    C2    C3
upper:  0.00  0.50  0.50
middle: 0.25  0.50  0.25
lower:  0.50  0.00  0.50
```

| 空きコート | 除外されるグループ |
|-----------|-----------------|
| C1 | upper (prob=0) |
| C2 | lower (prob=0) |
| C3 | なし（全員eligible） |

### 2コート確率テーブル

```
         C1    C2
upper:  0.70  0.30
lower:  0.30  0.70
```

prob=0 が存在しないため、全員eligible。

### 設計判断: ランダム間引きを廃止した理由

旧実装では `Math.random() > prob * 1.5` でランダムに除外していたが、以下の問題があった:
- **gamesPlayed=0 の人が間引かれる**: 最優先（-Infinity）であるべき未プレイ者がフィルタ段階で候補から外れる
- **候補プールの縮小**: selectBestFour の探索空間が狭まり、良い組み合わせを見逃す

→ ランダム性は Step 3 のペナルティスコアとして組み込み、候補から除外しない方式に変更。

---

## Step 3: コート適性ペナルティ

eligible な各プレイヤーに対して、対象コートとの適性に基づくペナルティを計算。

```
penalty = Math.random() × (1 - courtProb)
```

| グループ | C1での prob | C1での penalty範囲 |
|---------|-----------|-------------------|
| middle | 0.25 | 0 〜 0.75 |
| lower | 0.50 | 0 〜 0.50 |

**例外: gamesPlayed=0 のプレイヤーはペナルティなし（0固定）**

→ 優先スコアが -Infinity なのでペナルティを足しても -Infinity のまま。最優先が保証される。

### ランダム性の効果

- `Math.random()` により毎回異なるペナルティが付与され、同じ待機プールでも結果が変わる
- courtProb が低いほどペナルティ幅が大きく、そのコートに「向いていない」人が選ばれにくくなる
- ただし確率0以外は完全除外されないため、候補プールは維持される

---

## Step 4: selectBestFour（組み合わせ探索）

### 入力
- `candidates`: eligible プレイヤー（優先スコア昇順）
- `matchHistory`: 試合履歴
- `groups3`: 3コート用グループ分け（3コート時のみ）
- `courtPenalties`: Step 3 で計算したペナルティ

### スコア計算

各4人の組み合わせに対して:

```
comboScore = Σ playerScore(p)

playerScore(p) =
  gamesPlayed === 0  → -Infinity（最優先保証）
  otherwise          → calculatePriorityScore(p) + courtPenalty(p)
```

`calculatePriorityScore`:

| 設定 | 計算式 |
|------|-------|
| 滞在時間考慮 ON | `gamesPlayed / max(滞在分, 5)` |
| 滞在時間考慮 OFF | `gamesPlayed` |

### 制約チェック（有効性判定）

| # | 制約 | 条件 | 適用 |
|---|------|------|------|
| A | 直近試合重複 | 候補4人それぞれの直近2試合と3人以上が同じ | 全コート数 |
| B | 上位/下位孤立 | upper1人+lower3人 or lower1人+upper3人 | 3コート以上 |

#### 制約Aの詳細: 直近試合重複チェック

**個人視点**で判定する。グローバル直近N試合ではない。

```
候補4人 = [A, B, C, D]

Aの直近2試合をチェック → いずれかと3人以上重複？
Bの直近2試合をチェック → いずれかと3人以上重複？
Cの直近2試合をチェック → いずれかと3人以上重複？
Dの直近2試合をチェック → いずれかと3人以上重複？
→ 1つでもヒットしたらNG
```

**なぜ個人視点か:**
3コート並行運用では、ある人の前回試合がグローバル直近3試合の窓から外れる。
例: Aが試合#1に出場 → 試合#2,#3,#4が他コートで進行 → 試合#5でAが再配置
→ グローバル直近3=[#4,#3,#2]、Aの前回=#1は範囲外 → 重複検出できない。
個人視点なら、Aの直近2試合=#1を必ず参照する。

### 探索アルゴリズム

```
全 C(N,4) の組み合わせを列挙
  → 制約A, B を満たすか判定
  → 有効な組の中で comboScore が最小のものを選出
```

計算量: 待機20人で C(20,4)=4,845 → 問題なし

### フォールバック

1. eligible < 4人 → グループ制約(prob=0)を緩和して全activeから再探索
2. 全組み合わせが制約NG → 上位4人を制約無視で採用（最終手段）

---

## Step 5: formTeams（チーム編成）

選出された4人 [A, B, C, D] から3パターンを試行:

| パターン | チーム1 | チーム2 |
|---------|--------|--------|
| 1 | A-B | C-D |
| 2 | A-C | B-D |
| 3 | A-D | B-C |

### スコア計算

```
ペア履歴ペナルティ:  同チームで過去に組んだことがある → +10
対戦履歴ペナルティ:  対戦相手として過去に当たった    → +5 (×4組)
```

最小スコアのパターンを採用。

---

## 制約の強さまとめ

| 優先度 | 制約 | 種類 | 緩和条件 |
|-------|------|------|---------|
| 1 | グループ prob=0 | ハード除外 | eligible < 4人時 |
| 2 | 直近3試合重複 | 組み合わせ制約 | 全C(N,4)がNG時 |
| 3 | 上位/下位孤立 | 組み合わせ制約 | 全C(N,4)がNG時 |
| 4 | コート適性 | スコアペナルティ | 緩和なし（スコアに組み込み） |
| 5 | ペア/対戦履歴 | チーム編成最適化 | 緩和なし（best effort） |

---

## 特殊ケース

### 2コート同時配置（ホリスティック・アプローチ）

`totalCourtCount === 2 && courtCount === 2` の場合、上記フローではなく
`assign2CourtsHolistic` が使用される。

1. 優先スコア順で8人を選出
2. 序列順に並べ替え
3. 確率 + ランダムノイズでC1/C2に振り分け
4. コート間で直近試合重複をスワップ修正
5. 各コートでチーム編成

### 待機リスト表示ソート（`sortWaitingPlayers`）

UIの待機メンバー表示順は配置ロジックと連動:

1. 空きコートに対して eligible (prob > 0) な人を上位
2. 同じ eligible 区分内で優先スコア昇順
3. ineligible な人を下位（優先スコア昇順）

※ ランダムペナルティ・直近重複制約は表示には反映しない（実行時に決まるため）
