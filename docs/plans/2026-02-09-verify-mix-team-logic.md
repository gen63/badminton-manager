# MIXペアリングと最強+最弱ロジックの検証

**日付**: 2026-02-09
**対象**: `src/lib/algorithm.ts` の `formTeams` 関数
**関連**: `2026-02-07-fix-member-pairing-logic.md`, `2026-02-09-gender-matching-logic.md`

---

## 検証の目的

MIX（男女混合ペア）考慮を加えた `formTeams` が、「最強+最弱が組む」原則を正しく維持しているか確認する。

---

## 現在のロジック（`formTeams` L268-304）

```
1. 4人を序列順にソート → [1位, 2位, 3位, 4位]
2. 全員性別設定済み && 2M+2F の場合:
   a. デフォルト（1+4 vs 2+3）がMFペアか確認
   b. MFペアでなければ代替（1+3 vs 2+4）を試す
3. それ以外 → デフォルト（1+4 vs 2+3）
```

---

## 全パターン網羅分析

2M+2Fの配置パターンは C(4,2) = 6通り:

### デフォルト（1+4 vs 2+3）が使われるケース（4/6パターン）

| # | 序列 | デフォルト | MIX? | 最強+最弱 |
|---|------|-----------|------|----------|
| 1 | M,M,F,F | 1M+4F vs 2M+3F | MF vs MF ✓ | ✓ 維持 |
| 2 | M,F,M,F | 1M+4F vs 2F+3M | MF vs FM ✓ | ✓ 維持 |
| 5 | F,M,F,M | 1F+4M vs 2M+3F | FM vs MF ✓ | ✓ 維持 |
| 6 | F,F,M,M | 1F+4M vs 2F+3M | FM vs FM ✓ | ✓ 維持 |

→ **6パターン中4パターンはデフォルトでMIXが成立。最強+最弱は完全に維持。**

### 代替（1+3 vs 2+4）にフォールバックするケース（2/6パターン）

| # | 序列 | デフォルト | 代替 | MIX? |
|---|------|-----------|------|------|
| 3 | **M,F,F,M** | 1M+4M=MM ✗ | 1M+3F vs 2F+4M | MF vs FM ✓ |
| 4 | **F,M,M,F** | 1F+4F=FF ✗ | 1F+3M vs 2M+4F | FM vs MF ✓ |

→ **これら2パターンのみ、代替ペアリングが使用される。**

---

## 代替ペアリングのチームバランス影響

具体例: レーティングが等間隔の場合

```
序列: [M:2000, F:1800, F:1600, M:1400]  (パターン3: MFFM)

デフォルト（1+4 vs 2+3）:  ← MIX不成立のため不採用
  Team A: 2000 + 1400 = 3400
  Team B: 1800 + 1600 = 3400
  差: 0（完璧なバランス）

代替（1+3 vs 2+4）:  ← MIX成立のため採用
  Team A: 2000 + 1600 = 3600
  Team B: 1800 + 1400 = 3200
  差: 400（Team Aが有利）
```

### 一般式でのバランス差

```
r1 > r2 > r3 > r4 とする

デフォルト: (r1+r4) - (r2+r3) = (r1-r2) - (r3-r4)
  → 等間隔なら 0

代替:       (r1+r3) - (r2+r4) = (r1-r2) + (r3-r4)
  → 常に ≥ 0（Team Aが必ず同等以上）
  → 等間隔なら 2d（d = 隣接レーティング差）
```

**代替ペアリングでは1位+3位のチームが常に有利になる。**

---

## 問題の深刻度

### 実運用での影響範囲

- MFFM / FMMF の2パターンのみ影響（全パターンの1/3）
- 影響が出るのは「1位と4位が同性、2位と3位が同性」のケース
- `selectBestFour` の性別ペナルティが機能していれば、2M+2Fの組み合わせ自体が優先されるため、このパターンはそもそも出にくい

### バランス崩れの程度

| レーティング差 | デフォルト差 | 代替差 | 影響 |
|--------------|------------|--------|------|
| 全員同一 (1500全員) | 0 | 0 | なし |
| 小差 (50刻み) | 0 | 100 | 軽微 |
| 中差 (100刻み) | 0 | 200 | やや気になる |
| 大差 (200刻み) | 0 | 400 | 明確な差 |

### 設計上の意図

`2026-02-09-gender-matching-logic.md` の設計方針:
> 「やや優先」= 1試合差以内のプレイヤー間で入替が発生する程度

→ MIXのために**チーム編成**を変更することは明示されているが、
  バランスがどの程度崩れるかの許容範囲は定義されていない。

---

## 結論

### 正しく機能している部分

1. ✅ 6パターン中4パターン（MMFF, MFMF, FMFM, FFMM）で最強+最弱が維持される
2. ✅ 2M+2F以外（4M, 4F, 3+1, 性別未設定）では常に最強+最弱が使われる
3. ✅ デフォルトペアリングが最優先で試される
4. ✅ テストケースが主要パターンをカバー

### 懸念点

1. ⚠️ MFFM / FMMF パターン（2/6）で代替ペアリングが使われ、**チームバランスが崩れる**
   - 1位+3位 vs 2位+4位は、最強+最弱原則に反する
   - レーティング差が大きいほどバランス悪化が顕著
2. ⚠️ 代替で不採用の `1+2 vs 3+4` のほうがバランスが悪いのは事実だが、採用されている `1+3 vs 2+4` もデフォルトよりは劣る

### 判断

これは **「MIX優先」と「チームバランス」のトレードオフ** であり、設計上意図された挙動。
ただし、以下の点で改善の余地がある:

---

## 改善案（必要に応じて）

### 案A: 現状維持（推奨）

理由:
- MFFM/FMMF パターンの発生頻度が低い（selectBestFourで2M+2Fが選ばれた場合のうち1/3）
- バドミントンのダブルスでは、レーティング差200程度のチーム差は実際のゲーム結果に大きく影響しにくい
- MIX戦のほうがプレイヤーの満足度が高い場合が多い

### 案B: バランス差の上限チェック追加

```typescript
if (altIsMix) {
  // 代替ペアリングのバランス差をチェック
  const altBalance = Math.abs(
    (sorted[0].rating + sorted[2].rating) - (sorted[1].rating + sorted[3].rating)
  );
  const threshold = 300; // レーティング差の許容上限
  if (altBalance <= threshold) {
    return { teamA: [sorted[0].id, sorted[2].id], teamB: [sorted[1].id, sorted[3].id] };
  }
  // 閾値超過: MIXを諦めてデフォルト（最強+最弱）を使う
}
```

### 案C: テスト追加のみ

バランス崩れのパターンを明示的にテストに追加し、挙動を文書化する:
- MFFM/FMMFで代替が使われることの確認
- 代替使用時のチーム合計レーティング差の確認

---

## 推奨アクション

**案A（現状維持）** を推奨。理由:
1. 設計意図通りの挙動であり、バグではない
2. 発生頻度が低い
3. バランス差は実用上許容範囲

ただし、運用で「MIX時にチームバランスが悪い」というフィードバックがあれば、案Bの閾値チェックを検討する。
