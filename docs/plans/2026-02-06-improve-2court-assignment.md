# 2コート配置ロジックの改善

## 背景

2コート運用時、レートの高い人と低い人が同じコートに混在しやすい。
「一方のコートにレートの高い人、もう一方に低い人」という分離を強化したい。

## 現状の問題点

### 1. `groupPlayers2Court` がストリーク未対応
- 3コート用の `groupPlayers3Court` は `buildInitialOrder` + `applyStreakSwaps` を使って動的な序列調整をしている
- 2コート用は単純なレーティングソートのみで、連勝/連敗による昇降格が反映されない

### 2. 確率フィルタが弱い
- 現在: `Math.random() > prob * 1.3` でフィルタ
  - upper が C2 に入る確率: `0.30 * 1.3 = 0.39` → 39%パス
  - lower が C1 に入る確率: `0.30 * 1.3 = 0.39` → 39%パス
- 約4割の確率で「逆」のコートに入れてしまう

### 3. 順次処理の問題
- C1 → C2 と順番に処理するため、C1 が優先度の高い人を先に取る
- C2 は残り物になり、レベル分離が意図通りにならない

## 解決方針

### ホリスティック（全体最適）アプローチ

2コート同時配置時、コートごとに個別に処理するのではなく、全体を見て配置する：

1. **8人選出**: 優先度スコア（試合回数/滞在時間）で8人を選ぶ
2. **グループ分け**: 選ばれた8人をストリーク調整済み序列で upper/lower に分ける
3. **コート配置**: upper 4人を C1、lower 4人を C2 に割り当て
4. **制約チェック**: 直近3試合で3人同じを回避、必要ならスワップ
5. **チーム編成**: ペア履歴・対戦履歴を考慮して最適なチーム分けを行う

### `groupPlayers2Court` のストリーク対応

3コート用と同様に `buildInitialOrder` + `applyStreakSwaps` を使い、
連勝/連敗で動的にグループが変わるようにする。

## 変更箇所

### 1. `groupPlayers2Court` の更新
- `matchHistory` パラメータを追加
- `buildInitialOrder` + `applyStreakSwaps` で序列を構築
- レーティング値ではなく序列位置でグループ分け

### 2. `formTeams` ヘルパー関数の追加
- 4人から2チームを作る全3パターンを探索
- ペア履歴・対戦履歴のスコアリングで最適な組み合わせを選択

### 3. `assignCourts` に2コート専用パスを追加
- `totalCourtCount === 2 && courtCount === 2` の場合、ホリスティック配置を使用
- `courtCount === 1`（1コートだけ配置）の場合は既存ロジックを継続使用

### 4. 直近試合制約のスワップ対応
- ホリスティック配置後、各コートの4人を `hasSimilarRecentMatch` でチェック
- 違反があれば2コート間でプレイヤーをスワップして解消を試みる
