# 2コート配置ロジックの改善

## 背景

2コート運用時、レートの高い人と低い人が同じコートに混在しやすい。
「一方のコートにレートの高い人、もう一方に低い人」という分離を強化したい。
ただし完全分離ではなく、upper が 70% で C1、30% で C2 のように行き来させる。

---

## 配置ロジック全体像

### コート役割

| コートID | 役割 |
|----------|------|
| C1（小さいID） | upperコート（高レート寄り） |
| C2（大きいID） | lowerコート（低レート寄り） |

### 配置確率

```
COURT_PROBABILITIES_2:
  upper: [0.70, 0.30]  → C1に70%、C2に30%
  lower: [0.30, 0.70]  → C1に30%、C2に70%
```

---

## グローバルグループ分け

### 原則

upper/lower の判定は**全アクティブプレイヤー**（他コートでプレイ中を含む）で行う。
待機プレイヤーだけで判定すると、プレイ中の上位者が抜けた分だけグループがずれる。

### `allPlayers` オプション

```typescript
assignCourts(waitingPlayers, courtCount, matchHistory, {
  totalCourtCount: 2,
  targetCourtIds: [1],
  allPlayers: allActivePlayers,  // 全アクティブ（プレイ中含む）
})
```

- `allPlayers` が渡された場合 → それでグループ分け
- 未指定の場合 → `players`（待機者）でグループ分け（後方互換）

### グループ分けの手順（`groupPlayers2Court`）

1. `buildInitialOrder(allPlayers)` でレーティング降順の初期序列を構築
2. `applyStreakSwaps(initialOrder, matchHistory)` で連勝/連敗による動的調整
3. 序列の上位半分 → **upper**、下位半分 → **lower**

```
例: 15人 (p1=2000, p2=1900, ..., p15=600)
  初期序列: p1 > p2 > ... > p15
  upper: p1〜p7（上位7人）
  lower: p8〜p15（下位8人）
```

---

## 2コート同時配置（ホリスティック・アプローチ）

`totalCourtCount === 2 && courtCount === 2` の場合に使用。
両コートが空いている状態で、全体最適で配置する。

### フロー

```
1. 優先度ソート
   全待機プレイヤーを calculatePriorityScore で昇順ソート
   スコア = 試合回数 / max(滞在時間(分), 5)
   → スコアが低い人（長くいるのに試合が少ない）を優先
   → 試合0回の人は -Infinity で最優先

2. 必要人数選出
   上位 courtCount × 4 人を選ぶ

3. グローバルグループ分け
   allPlayers 全体でストリーク調整済み序列を構築
   → 選ばれた人のupper/lowerグループを判定

4. 確率ベースのコート振り分け
   各プレイヤーに score = probC1 + random() * 1.8 を付与
     upper: 0.70 + random * 1.8 → [0.70, 2.50]
     lower: 0.30 + random * 1.8 → [0.30, 2.10]
   スコア降順で上位4人 → C1、下位4人 → C2
   → 境界付近のプレイヤーほど行き来しやすい

5. 直近試合制約チェック
   各コートの4人が直近3試合のいずれかと3人以上重複 → スワップで解消

6. チーム編成
   4人から2チームを作る全3パターンを探索
   ペア履歴ペナルティ(+10) + 対戦履歴ペナルティ(+5×4) でスコアリング
   最低スコアの組み合わせを採用
```

---

## 1コート配置（片方のコートが空いた場合）

`totalCourtCount === 2 && courtCount === 1` の場合。
もう一方のコートはまだプレイ中。

### フロー

```
1. グローバルグループ分け
   allPlayers 全体で upper/lower を判定

2. 確率フィルタ
   待機プレイヤーの中から、対象コートの確率でフィルタ
   例: C1（upperコート）に配置する場合
     upper プレイヤー: prob=0.70 → 0.70*1.3=0.91 → 91%の確率で候補に残る
     lower プレイヤー: prob=0.30 → 0.30*1.3=0.39 → 39%の確率で候補に残る

3. 優先度ソート
   候補を calculatePriorityScore 昇順でソート

4. 4人選出（制約付き）
   - 直近3試合で3人以上同じ → スキップ
   - 制約で4人揃わない場合はフォールバック（制約緩和）

5. チーム編成
   ペア履歴・対戦履歴を考慮
```

---

## 優先度スコア（`calculatePriorityScore`）

```
スコア = 試合回数 / max(滞在時間(分), 5)
```

| 状況 | スコア | 優先度 |
|------|--------|--------|
| 試合0回 | -Infinity | **最優先** |
| 1試合 / 60分滞在 | 0.017 | 高い |
| 3試合 / 60分滞在 | 0.050 | 普通 |
| 5試合 / 60分滞在 | 0.083 | 低い |

- 滞在開始 = `max(練習開始時刻, 休憩解除時刻)`
- スコアが**低い人を優先**（長くいるのに試合が少ない人を選ぶ）

---

## ストリーク（連勝/連敗）による序列変動

### 仕組み

レーティング序列に対して、連勝/連敗で隣接する人と序列を入れ替える。
upper/lower のグループ分けはこの調整済み序列で決まる。

- **二連勝ごと** → 序列で1つ上の人と交代
- **二連敗ごと** → 序列で1つ下の人と交代

### 例

```
初期序列: A > B > C > D > E > F > G > H
                      ↑ upper/lower境界

--- D が二連勝 ---
D と C が交代: A > B > D > C > E > F > G > H
→ D が upper に昇格、C が lower に降格
```

---

## 直近試合制約

- 対象コートの4人と、直近3試合それぞれの4人を比較
- **3人以上が同じ** → 制約違反
- 2コート同時: コート間スワップで解消を試みる
- 1コート: 該当プレイヤーをスキップして次の候補を選ぶ

---

## 変更箇所まとめ

### `groupPlayers2Court` の更新
- `matchHistory` パラメータを追加
- `buildInitialOrder` + `applyStreakSwaps` で序列を構築
- レーティング値ではなく序列位置でグループ分け

### `formTeams` ヘルパー関数の追加
- 4人から2チームを作る全3パターンを探索
- ペア履歴・対戦履歴のスコアリングで最適な組み合わせを選択

### `assign2CourtsHolistic` の追加
- 2コート同時配置の専用パス
- 確率スコアリング（`probC1 + random * 1.8`）でコート振り分け

### `tryFixRecentMatch` の追加
- 直近試合制約違反時にコート間スワップで解消

### `assignCourts` の変更
- `allPlayers` オプション追加（グローバルグループ分け用）
- `totalCourtCount === 2 && courtCount === 2` → ホリスティックパス
- `courtCount === 1` → 既存ループ（グローバルグループ分けを使用）
