# 試合回数重視モードの追加

**日付**: 2026-02-09
**ステータス**: 計画中

---

## 背景・課題

現在、配置優先度の設定は「滞在時間を考慮した配置優先度」のON/OFFトグルで管理されている。

| 設定 | 優先スコア | 挙動 |
|------|-----------|------|
| ON（デフォルト） | `gamesPlayed / stayMinutes` | 長く居て試合が少ない人を優先 |
| OFF | `gamesPlayed` | 試合回数のみで優先度を決定 |

ユーザーから「**待機時間を考慮しない、試合回数をかなり優先したモード**」の要望あり。設定画面で「待機時間モード」「試合回数モード」を明確に切り替えたい。

### 現状OFFモードの課題

OFFモードでも以下のランダム要素が残るため、試合数が少ない人が確実に優先されるわけではない：

1. **コート適性ペナルティ**: `Math.random() * (1 - prob) * 1.0` で最大1.0のランダムペナルティが加算される
2. **hasSimilarRecentMatch制約**: 直近試合と3人以上重複するとリジェクトされる → 試合数が少ない人でも組み合わせによってはスキップされる

## 設計方針

### 方針: 既存のbooleanを「モード選択」UIに変更

内部的には `useStayDurationPriority: boolean` をそのまま維持し、UIを「モード選択」ボタンに変更する。

試合回数モード（OFF）では、コート適性ペナルティのスケーリングを小さくして試合回数の優先度をより厳格にする。

## 動作の違い

| 項目 | 待機時間モード（現ON） | 試合回数モード（現OFF） |
|------|----------------------|----------------------|
| 優先スコア | `gamesPlayed / stayMinutes` | `gamesPlayed` |
| コートペナルティ上限 | `1 / stayMinutes`（≈ 0.01〜0.2） | **0.3**（固定、小さめ） |
| 直近試合制約 | あり（3人以上重複NG） | あり（維持） |
| 未プレイ者の優先 | 最優先（-Infinity） | 最優先（-Infinity） |

### ペナルティ上限を0.3にする理由

- 現在のOFFモードでは `oneGameDelta = 1.0` → ペナルティ最大1.0
- gamesPlayedの差が1（1試合差）のとき、ペナルティが1.0だと逆転する可能性がある
- 0.3にすることで、1試合でも差があればほぼ確実に試合数が少ない人が優先される
- ただし0ではないため、同じ試合数の人の中ではコート適性がある程度反映される

## 変更対象ファイル

### 1. `src/lib/algorithm.ts`
- `assignCourts()` 内のコートペナルティ計算を修正
- `!useStayDuration` のとき `oneGameDelta = 0.3` に変更（現在は `1.0`）

### 2. `src/pages/SettingsPage.tsx`
- 既存のトグルスイッチを**2択セレクトボタン**に変更
- ラベル: 「配置モード」
- 選択肢:
  - **待機時間モード**: 滞在時間が長く試合が少ない人を優先
  - **試合回数モード**: 試合回数が少ない人を優先（待機時間を考慮しない）

### 3. `src/stores/settingsStore.ts`
- 変更不要（`useStayDurationPriority: boolean` をそのまま活用）
  - `true` = 待機時間モード
  - `false` = 試合回数モード

### 4. `src/pages/MainPage.tsx`
- 変更不要（既に `useStayDurationPriority` を `assignCourts` と `sortWaitingPlayers` に渡している）

## UI設計

設定画面の「コート設定」カード内：

```
┌─────────────────────────────────────┐
│ 🏸 コート設定                        │
│                                     │
│ コート数    [1] [2] [3]             │
│ 目標点数    [15] [21]               │
│ 体育館      [ドロップダウン]         │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 配置モード                       │ │
│ │                                  │ │
│ │ [✓ 待機時間モード] [試合回数モード]│ │
│ │                                  │ │
│ │ 滞在時間が長く試合が              │ │
│ │ 少ない人を優先します              │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

- 2つのボタンが横並び
- 選択中のボタンはアクティブスタイル（indigo背景）
- 下に現在のモードの説明テキストを表示

## 実装手順

1. `algorithm.ts`: OFFモード時のコートペナルティスケーリングを `0.3` に変更
2. `SettingsPage.tsx`: トグルUIを2択セレクトボタンに変更
3. `npm run build` でビルド確認
