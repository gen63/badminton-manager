# 試合回数重視モードの追加

**日付**: 2026-02-09
**ステータス**: 実装済み

---

## 背景・課題

現在、配置優先度の設定は「滞在時間を考慮した配置優先度」のON/OFFトグルで管理されている。

| 設定 | 優先スコア | 挙動 |
|------|-----------|------|
| ON（デフォルト） | `gamesPlayed / stayMinutes` | 長く居て試合が少ない人を優先 |
| OFF | `gamesPlayed` | 試合回数のみで優先度を決定 |

ユーザーから「**待機時間を考慮しない、試合回数をかなり優先したモード**」の要望あり。設定画面で「待機時間モード」「試合回数モード」を明確に切り替えたい。

### 現状OFFモードの課題

OFFモードではコート適性ペナルティが `Math.random() * (1 - prob) * 1.0` で最大1.0のため、1試合差でも容易に逆転が起きる。試合回数の優先が実質的に効いていない。

一方でペナルティを小さくしすぎると、**1コート8人のような少人数運用でランダム性が完全に失われ**、同じ4人と4人が交互にプレイし続ける問題が発生する。

## 設計方針

### 2つの調整で解決

1. **優先スコアのスケーリング**: `gamesPlayed` をそのまま使うのではなく、ゲーム重みをかけて `gamesPlayed * GAME_WEIGHT` とする
2. **コートペナルティ上限**: 0.8（`(1-prob)` スケーリングを撤廃し、純粋なランダムノイズとして機能させる）

`GAME_WEIGHT` と `ペナルティ上限` の関係で逆転範囲が決まる：

- 逆転可能条件: `差分試合数 * GAME_WEIGHT ≤ ペナルティ上限`
- **GAME_WEIGHT = 0.4** のとき: 2試合差 × 0.4 = **0.8** = ペナルティ上限 → 境界（まれに逆転）
- 3試合差 × 0.4 = 1.2 > 0.8 → 逆転不可能（厳格に優先）

### コートペナルティから `(1-prob)` を外す理由

現在のペナルティ: `Math.random() * (1 - prob) * oneGameDelta`

- 1コート運用では `prob = 0.5`（デフォルト）のため、ペナルティが半減する
- 試合回数モードではコート適性よりも**ランダム性の確保**が重要
- ハード制約（prob=0のコートは除外）は維持されるため、極端な不適性は回避される
- `(1-prob)` を外すことで全コート構成で一貫したランダム性を確保

## 動作の違い

| 項目 | 待機時間モード（現ON） | 試合回数モード（現OFF） |
|------|----------------------|----------------------|
| 優先スコア | `gamesPlayed / stayMinutes` | `gamesPlayed * 0.4` |
| コートペナルティ | `random * (1-prob) * (1/stayMin)` | `random * 0.8` |
| 1試合差の逆転 | コート適性による | **頻繁に発生**（ランダム性確保） |
| 2試合差の逆転 | コート適性による | **まれに発生**（境界） |
| 3試合差以上の逆転 | コート適性による | **発生しない**（厳格に優先） |
| 直近試合制約 | あり（3人以上重複NG） | あり（維持） |
| 未プレイ者の優先 | 最優先（-Infinity） | 最優先（-Infinity） |

### 1コート8人シナリオの検証

`gamesPlayed * 0.4` + ペナルティ `random * 0.8`:

| 試合数 | スコア範囲 | 備考 |
|--------|-----------|------|
| 0回 | -Infinity | 最優先（初回保証） |
| 1回 | [0.4, 1.2] | |
| 2回 | [0.8, 1.6] | 1回との重複: [0.8, 1.2] → 十分なシャッフル |
| 3回 | [1.2, 2.0] | 1回とは重複なし → 1回が確実に優先 |

- 同試合数同士: スコア範囲が完全に重複 → **フルランダム** ✓
- 1試合差: スコア範囲の約半分が重複 → **適度にシャッフル** ✓
- 2試合差: スコア範囲の端のみ重複 → **まれに逆転** ✓
- 3試合差以上: 重複なし → **厳格に優先** ✓

## 変更対象ファイル

### 1. `src/lib/algorithm.ts`

#### `calculatePriorityScore()` の変更
```typescript
// 試合回数モード
if (!useStayDuration) {
  return player.gamesPlayed * 0.4;  // 変更: 1.0 → 0.4
}
```

#### コートペナルティ計算の変更（`assignCourts()` 内）
```typescript
if (useStayDuration) {
  // 待機時間モード（変更なし）
  const stayStart = Math.max(practiceStartTime, p.activatedAt ?? now);
  const stayMinutes = Math.max((now - stayStart) / (1000 * 60), 5);
  oneGameDelta = 1 / stayMinutes;
  courtPenalties.set(p.id, Math.random() * (1 - prob) * oneGameDelta);
} else {
  // 試合回数モード（新ロジック）
  courtPenalties.set(p.id, Math.random() * 0.8);
}
```

#### `assign2CourtsHolistic()` への反映
- 2コート同時配置でも同じスケーリングを適用
- `courtScores` のランダムノイズ部分は既存のままで問題なし（別ロジック）

### 2. `src/pages/SettingsPage.tsx`
- 既存のトグルスイッチを**2択セレクトボタン**に変更
- ラベル: 「配置モード」
- 選択肢:
  - **待機時間モード**: 滞在時間が長い人を優先
  - **試合回数モード**: 試合回数が少ない人を優先（待機時間を考慮しない）

### 3. `src/stores/settingsStore.ts`
- 変更不要（`useStayDurationPriority: boolean` をそのまま活用）
  - `true` = 待機時間モード
  - `false` = 試合回数モード

### 4. `src/pages/MainPage.tsx`
- 変更不要（既に `useStayDurationPriority` を `assignCourts` と `sortWaitingPlayers` に渡している）

## UI設計

設定画面の「コート設定」カード内：

```
┌─────────────────────────────────────┐
│ 🏸 コート設定                        │
│                                     │
│ コート数    [1] [2] [3]             │
│ 目標点数    [15] [21]               │
│ 体育館      [ドロップダウン]         │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 配置モード                       │ │
│ │                                  │ │
│ │ [✓ 待機時間モード] [試合回数モード]│ │
│ │                                  │ │
│ │ 滞在時間が長い人を優先します       │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

- 2つのボタンが横並び
- 選択中のボタンはアクティブスタイル（indigo背景）
- 下に現在のモードの説明テキストを表示

## 実装手順

1. `algorithm.ts`: `calculatePriorityScore` でゲーム重み `* 0.4` を適用
2. `algorithm.ts`: 試合回数モード時のコートペナルティを `random * 0.8` に変更
3. `SettingsPage.tsx`: トグルUIを2択セレクトボタンに変更
4. `npm run build` でビルド確認
