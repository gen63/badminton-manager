# 3コート配置確率の変更

## 背景

3コート運用時、プレイヤーをレーティング順に upper / middle / lower の3グループに分け、
各グループがどのコートに配置されるかを確率で制御している。

現在の確率設定ではコートの実態と合わない部分があるため、配置先を変更する。

## 変更内容

### 配置確率 (`COURT_PROBABILITIES_3`)

**現在:**

```
           C1     C2     C3
upper:   [0.50,  0.50,  0.00]   ← C1,C2のみ（C3には入らない）
middle:  [0.25,  0.50,  0.25]
lower:   [0.00,  0.50,  0.50]   ← C2,C3のみ（C1には入らない）
```

**変更後:**

```
           C1     C2     C3
upper:   [0.00,  0.50,  0.50]   ← C2,C3のみ（C1には入らない）
middle:  [0.25,  0.50,  0.25]   ← 変更なし
lower:   [0.50,  0.00,  0.50]   ← C1,C3のみ（C2には入らない）
```

### 各コートの構成

| コート | 配置されるグループ |
|--------|-------------------|
| C1     | middle, lower     |
| C2     | upper, middle     |
| C3     | upper, middle, lower（全グループ） |

---

## レーティング0（未設定）の扱い

- レーティングが0のプレイヤーは、序列に関わらず **middle に固定配置**する
- 初期序列の構築時、レーティング0のプレイヤーは序列から除外し、middle グループに直接配置
- 連勝/連敗による序列入れ替えの対象にはならない（常に middle）

### 例

```
プレイヤー: A(1800), B(1600), C(1400), X(0), D(1200), E(1000)

序列（レーティング0を除外）: A > B > C > D > E
X は middle に固定

グループ分け（5人 + 固定1人の場合）:
  [upper]  A, B        ← 序列上位
  [middle] C, X, D     ← 序列中位 + レーティング0
  [lower]  E           ← 序列下位
```

---

## 連勝/連敗によるランク入れ替え

### 仕組み

レーティング序列（降順ソート）に対して、連勝/連敗で隣接する人と序列を入れ替える。
グループ分け (upper/middle/lower) はその序列の結果として決まる。

- **二連勝** → レーティング序列で1つ上の人と交代
- **二連敗** → レーティング序列で1つ下の人と交代

### 仕様詳細

| 項目 | 決定事項 |
|------|---------|
| 交代相手 | レーティング序列で隣接する人（境界の人） |
| 上限/下限 | 最上位/最下位でも同様に隣接する人と序列交代（グループ内で順位が変動） |
| カウントリセット | リセットしない（連勝が続けばさらに昇格） |
| 休憩中の扱い | 休憩を挟んでも記録は継続 |

### 例：基本動作

```
初期レーティング序列: A > B > C | D > E > F | G > H > I
                      [upper]     [middle]    [lower]

--- D が二連勝 ---
D と C（1つ上）の序列が交代:
  A > B > D | C > E > F | G > H > I
  [upper]     [middle]    [lower]
  → D が upper に昇格、C が middle に降格
```

### 例：グループ内での昇格

```
序列: A > B > D | C > E > F | G > H > I
      [upper]     [middle]    [lower]

--- D がさらに連勝（リセットなし、三連勝目で再度発動） ---
D と B（1つ上）の序列が交代:
  A > D > B | C > E > F | G > H > I
  [upper]     [middle]    [lower]
  → グループは変わらないが upper 内の順位が変動
```

### 例：middle からの昇格（隣接位置）

```
序列: A > B > C | D > E > F | G > H > I
      [upper]     [middle]    [lower]

--- F が二連勝 ---
F と E（1つ上）の序列が交代:
  A > B > C | D > F > E | G > H > I
  [upper]     [middle]    [lower]
  → middle 内の順位が変動（グループは変わらない）

--- F がさらに連勝 ---
F と D（1つ上）の序列が交代:
  A > B > C | F > D > E | G > H > I
  [upper]     [middle]    [lower]

--- F がさらに連勝 ---
F と C（1つ上）の序列が交代:
  A > B > F | C > D > E | G > H > I
  [upper]     [middle]    [lower]
  → F が upper に昇格、C が middle に降格
```

---

## 変更箇所（まとめ）

### 1. 配置確率の変更
- `src/lib/algorithm.ts` 8-11行目: `COURT_PROBABILITIES_3` の値のみ変更
- middle の確率は変更なし

### 2. ランク入れ替えロジック（新規）
- 連勝/連敗の判定: matchHistory から各プレイヤーの直近の勝敗を算出
- レーティング序列の管理: 初期値はレーティング降順、連勝/連敗で動的に入れ替え
- `groupPlayers3Court()` を序列ベースに変更（レーティング値ではなく序列で分割）

### 実装方針
- セッション中の「動的序列」を管理する仕組みが必要
  - 案A: gameStore に `ratingOrder: string[]` を追加して永続化
  - 案B: assignCourts 呼び出し時に matchHistory から毎回序列を再計算
- 連勝/連敗の判定は matchHistory から算出可能（プレイヤーへの状態追加不要）
