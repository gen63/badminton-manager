# コート配置の固定化 (upper→C1, middle→C2, lower→C3)

**日付**: 2026-02-10
**対象**: `src/lib/algorithm.ts` の確率テーブル・配置ロジック

---

## 背景・課題

### 現状
各グループ（upper/middle/lower）がコートに配置される確率が分散している：

```
         C1    C2    C3
upper:  0.00  0.50  0.50     ← upperはC2/C3のどちらか
middle: 0.25  0.50  0.25     ← middleは全コートに分散
lower:  0.50  0.00  0.50     ← lowerはC1/C3のどちらか
```

**問題**: どのコートに配置されるか予測しにくい。

### 目標
- **upper → C1、middle → C2、lower → C3** にほぼ固定
- 勝利による序列移動で自然な流動性を確保
- 敗北による序列降下で閉塞感を防止
- 全く同じ顔ぶれでの連続試合は回避
- **最頻出構成**: 3コート、14-21人

---

## シミュレーション結果

### 1. 7人グループ内のデッドロック問題

21人を3分割すると各グループ7人。7人から4人を連続選出する際、
現行の`hasSimilarRecentMatch`（各個人の直近2試合/3人以上重複禁止）は
**ラウンド6でデッドロック**する。

```
R1: [P1, P2, P3, P4]
R2: [P5, P6, P7, P1]
R3: [P2, P3, P5, P6]
R4: [P4, P7, P2, P5]
R5: [P3, P4, P6, P7]
R6: DEADLOCK（有効な組み合わせなし）
```

**原因**: 7人で直近2試合×3人重複禁止は、全C(7,4)=35通りのうち有効な組が枯渇する。

### 2. パラメータ比較（7人グループ）

| 制約パラメータ | 結果 |
|-------------|------|
| 直近2試合/3人重複（現行） | **デッドロック@R6** |
| 直近1試合/3人重複 | 30ラウンドOK |
| 直近2試合/4人重複 | 30ラウンドOK |
| 直近1試合/4人重複 | 30ラウンドOK |

### 3. 確率テーブル比較（21人、20ラウンド、100回平均）

| 方式 | cross-group | deadlock | 同一連続 |
|------|-----------|----------|---------|
| **現行（分散）** | 183.0回 | 0.0回 | 0.0回 |
| **固定（prob>0）** `[0.90, 0.05, 0.05]` | **12.0回** | **0.0回** | **0.0回** |
| 完全固定（prob=0） `[1.0, 0.0, 0.0]` | 0.0回 | **18.0回** | 0.0回 |
| 完全固定 + 制約緩和（直近1試合） | 0.0回 | 0.0回 | 0.0回 |

### 4. 公平性（20ラウンド後の試合数分布）

| 方式 | min | max | avg | stddev |
|------|-----|-----|-----|--------|
| 現行（分散） | 11 | 12 | 11.4 | 0.49 |
| 完全固定（prob=0） | 8 | 12 | 11.4 | **1.40** |

→ 完全固定はデッドロック時のフォールバックで公平性が悪化。

### 5. 性別パターン別（固定 prob=0.90）

| パターン | MIX率 | 同性率 | 3-1率 | deadlock |
|----------|-------|-------|-------|----------|
| 女性5割(3,4,3) | 75% | 23% | 2% | 0 |
| 女性5割偏り(5,4,1) | 50% | 32% | 18% | 0 |
| 女性3割(2,2,2) | 48% | 30% | 22% | 0 |
| 女性3割偏り(3,2,1) | 45% | 37% | 18% | 0 |
| 女性2割(1,2,1) | 25% | 50% | 25% | 0 |
| 女性2割偏り(0,2,2) | 30% | 53% | 17% | 0 |
| 女性1割(0,1,1) | 12% | 73% | 15% | 0 |

### 6. 確率テーブル × 性別（女性3割/各グループ2人、100回平均）

| 方式 | MIX率 | 同性率 | 3-1率 |
|------|-------|-------|-------|
| 現行（分散） | 51.7% | 48.3% | 0.0% |
| **固定（prob>0）** | **48.3%** | **30.0%** | **21.7%** |
| 完全固定 | 40.0% | 20.0% | 40.0% |

---

## 分析

### 7. 14-21人 × 確率テーブル比較（100回平均、20ラウンド）

| 人数 | グループ | 方式 | crossGroup | deadlock | 公平性(stddev) |
|------|---------|------|-----------|----------|---------------|
| 14人 | 4/6/4 | 現行(分散) | 176.0 | 0.0 | 0.35 |
| 14人 | 4/6/4 | 固定(0.90) | 73.0 | 0.0 | 0.52 |
| 14人 | 4/6/4 | 完全固定 | 0.0 | **55.0** | **3.31** |
| 15人 | 5/5/5 | 固定(0.90) | 54.0 | 0.0 | 0.37 |
| 15人 | 5/5/5 | 完全固定 | 0.0 | **57.0** | 0.00 |
| 16人 | 5/6/5 | 固定(0.90) | 45.0 | 0.0 | 0.50 |
| 17人 | 5/7/5 | 固定(0.90) | 41.0 | 0.0 | 0.32 |
| 18人 | 6/6/6 | 固定(0.90) | 34.0 | 0.0 | 0.47 |
| 19人 | 6/7/6 | 固定(0.90) | 23.0 | 0.0 | 0.48 |
| 20人 | 6/8/6 | 固定(0.90) | 27.0 | 0.0 | 0.32 |
| 21人 | 7/7/7 | 固定(0.90) | 12.0 | 0.0 | 0.58 |

→ 固定(0.90)は**全人数でデッドロック0**。人数が少ないほどcross-groupが増えるが、これはグループが小さいことによる数学的制約。

### 8. グループサイズ別デッドロック閾値

| グループサイズ | 直近2/重複3(現行) | 直近1/重複3 | 直近2/重複4 |
|--------------|------------------|------------|------------|
| 4人 | **R2でデッドロック** | R2 | R2 |
| 5人 | **R2でデッドロック** | R2 | OK |
| 6人 | **R4でデッドロック** | OK | OK |
| 7人 | **R6でデッドロック** | OK | OK |
| 8人 | OK | OK | OK |

→ **8人以上でなければ現行制約を完全固定で運用できない**。14-17人の最小グループ(4-5人)は特に厳しい。

### 9. 隣接グループ借用方式（100回平均）

**ロジック**: homeグループ内でデッドロック → 隣接グループの序列境界メンバーを1人ずつ候補に追加して再探索

| 人数 | グループ | crossGroup | deadlock | 借用回数 | 公平性(stddev) |
|------|---------|-----------|----------|---------|---------------|
| 14人 | 4/6/4 | 60.0 | 5.0 | 43.0 | 1.68 |
| 15人 | 5/5/5 | 41.0 | 9.0 | 39.0 | 2.25 |
| 16人 | 5/6/5 | 41.0 | 0.0 | 39.0 | 2.26 |
| 17人 | 5/7/5 | 36.0 | 0.0 | 35.0 | 1.84 |
| 18人 | 6/6/6 | 24.0 | 0.0 | 24.0 | 1.89 |
| 19人 | 6/7/6 | 18.0 | 0.0 | 18.0 | 1.09 |
| 20人 | 6/8/6 | 16.0 | 0.0 | 16.0 | 0.32 |
| **21人** | 7/7/7 | **7.0** | **0.0** | **7.0** | 0.58 |

21人の借用詳細（1回分の実行例）:
```
R 6 C1(upper):  隣接1人追加で解決
R 6 C2(middle): 隣接1人追加で解決
R 6 C3(lower):  隣接1人追加で解決
R12 C2(middle): 隣接1人追加で解決
R12 C3(lower):  隣接1人追加で解決
R18 C3(lower):  隣接1人追加で解決
R20 C1(upper):  隣接1人追加で解決
```
→ 約6ラウンドに1回、各コートで1人だけ借用が発生。

### 10. 方式比較（21人、100回平均）

| 方式 | crossGroup | deadlock | sameRepeat | 公平性 |
|------|-----------|----------|------------|--------|
| 固定(0.90) | 12.0 | 0.0 | 0.0 | 0.58 |
| **借用方式** | **7.0** | **0.0** | **0.0** | **0.58** |

---

## 推奨方式の比較

### 選択肢A: 確率テーブル `[0.90, 0.05, 0.05]`

| 利点 | 欠点 |
|------|------|
| 実装が最もシンプル（テーブル変更のみ） | cross-group がランダムに発生（意図的でない） |
| 全人数(14-21)でデッドロック0 | 14人で73回/240回(30%)がcross-group |
| 制約パラメータ変更不要 | 確率ベースのため結果の説明が難しい |

### 選択肢B: 借用方式（推奨）

| 利点 | 欠点 |
|------|------|
| cross-groupが最小限（21人:7回、必要時のみ） | 実装の変更量がやや多い |
| 「なぜこの人がこのコートに？」が説明しやすい | 14-15人でまだ少数のデッドロック |
| 隣接グループの序列境界から借用 = スキル的に自然 | - |
| 借用は1人で済む（21人の場合） | - |

### **推奨: 選択肢B（借用方式）**

理由:
1. **最頻出の21人で cross-group わずか7回/240回（3%）** ← 選択肢A(5%)より少ない
2. **意図的な借用**: ランダムではなく、デッドロック時にのみ隣接グループの序列境界から借用
3. **説明可能性**: 「同じ顔ぶれを避けるため、隣のレベル帯から1人借りた」と説明できる
4. 21人では**常に1人だけの借用**で解決

### 性別マッチングへの影響

- **女性5割**: 3-1率わずか2%。問題なし
- **女性3割**: 3-1率22%。グループ内の女性が2人だと数学的に3-1が発生しやすい（C(7,4)の57%が3-1構成）。ペナルティで最小化はしているが完全回避は不可
- **女性2割以下**: 同性試合が主体（50-73%）。MIXの機会が限られるのは人数構成上の制約
- **現行との差**: 現行は cross-group による大きなプールから選べるため3-1率0%。固定化すると各グループ7人のプール制限で3-1が増える

**トレードオフ**: コートの予測可能性 vs 性別マッチング品質。借用方式でも最小限のcross-groupが性別バランス調整のバッファとして機能する。

---

## 敗北時の序列降下（閉塞感の打開）

### 現行の問題

現行の `applyStreakSwaps` は**敗北時に序列が一切動かない**:

```typescript
// 現行: ストリークリセットのみ
for (const id of losers) {
  streaks.set(id, 0);  // 位置は変わらない
}
```

コート固定化すると、同じ7人がずっと同じコートに留まる。
勝ちでしか序列が動かないため、特にグループ最上位/最下位のプレイヤーが固定されやすい。

### 検討した3案

| | A: 1つ下がる | B: 即グループ降格 | **C: ceil(groupSize/3)下がる** |
|---|---|---|---|
| 閉塞感の打開 | 弱い | 最強 | **中〜強** |
| 実力帯の維持 | 高い | 低い（混ざる） | **中程度** |
| わかりやすさ | 普通 | 最も直感的 | やや複雑 |
| 精神的負担 | 小さい | 大きい | **中程度** |
| コート変動/ラウンド | ~1人 | ~6人 | **~2-3人** |
| 実力差マッチ発生 | 少ない | 多い | **やや多い** |

### 採用: C案（グループサイズ連動の降下）

**「2連敗でグループ境界を越える」** を目標に、drop量を自動計算:

```
dropAmount = ceil(groupSize / 2)
```

#### 人数別のdrop量

| 人数 | グループサイズ | drop量 | 降格に必要な連敗数 |
|------|-------------|--------|-----------------|
| 14人 | 4 | 2 | 2敗 |
| 16人 | 5 | 3 | 2敗 |
| 18人 | 6 | 3 | 2敗 |
| 21人 | 7 | 4 | 2敗 |
| 8人(2コート) | 4 | 2 | 2敗 |
| 10人(2コート) | 5 | 3 | 2敗 |
| 12人(2コート) | 6 | 3 | 2敗 |

→ **全パターンで「2連敗で降格」に統一。** 調整不要で自動スケール。

#### シミュレーション結果（借用方式 + 敗北降下、100回平均、20ラウンド）

勝利: 1つ上（2連勝でgroupSizeジャンプ）、敗北: ceil(gs/2)下がる、50%ランダム勝敗

| 人数 | 方式 | cross | dead | borrow | grpChange | 対戦相手数(avg) | 公平性 |
|------|------|-------|------|--------|-----------|----------------|--------|
| 14人 | 敗北移動なし | 45.2 | 6.5 | 31.7 | 55.6 | 12.7 | 0.77 |
| 14人 | **ceil(gs/2)** | **36.9** | **5.0** | **27.0** | **81.3** | **12.8** | **0.70** |
| 16人 | 敗北移動なし | 24.3 | 0.3 | 23.8 | 60.5 | 13.9 | 0.86 |
| 16人 | **ceil(gs/2)** | **12.5** | **0.1** | **12.4** | **91.8** | **14.3** | **0.58** |
| 18人 | 敗北移動なし | 3.9 | 0.0 | 3.9 | 64.2 | 14.7 | 0.70 |
| 18人 | **ceil(gs/2)** | **1.6** | **0.0** | **1.6** | **82.3** | **15.3** | **0.57** |
| 21人 | 敗北移動なし | 0.1 | 0.0 | 0.1 | 63.4 | 15.3 | 0.70 |
| 21人 | **ceil(gs/2)** | **0.0** | **0.0** | **0.0** | **85.1** | **16.4** | **0.53** |

**敗北降下(ceil(gs/2))の効果:**

1. **グループ変動(grpChange)が +34%増加** (21人: 63.4→85.1)
   → 1ラウンドあたり約4.3人がグループ境界を越える。閉塞感の打開に有効
2. **対戦相手数が +7%増加** (21人: 15.3→16.4人)
   → 20ラウンドで平均16.4人の異なる相手と対戦（21人中）
3. **crossGroupがほぼ0** (21人: 0.1→0.0)
   → 序列変動でグループメンバーが入れ替わるため、借用の必要性が激減
4. **公平性が改善** (21人: stddev 0.70→0.53)
   → メンバーが入れ替わることで試合数の偏りも減少

#### ceil(gs/2) vs ceil(gs/3) の比較

| 指標 (21人) | ceil(gs/3) 3敗で越え | ceil(gs/2) 2敗で越え |
|------------|---------------------|---------------------|
| grpChange | 74.1 | **85.1** |
| 対戦相手数 | 16.0 | **16.4** |
| 公平性 | 0.57 | **0.53** |

→ **ceil(gs/2)（2連敗で越え）の方が全指標で優位。** 閉塞感打開の効果がより強い。

#### 勝敗の非対称性

| | 上昇 | 降下 |
|---|---|---|
| 通常 | 1勝 → 1つ上 | 1敗 → ceil(gs/2)下 |
| 連続 | 2連勝 → groupSize分ジャンプ | 2連敗 → 降格 |

**負けの方がやや重い設計** → グループ間の流動性を確保。
「勝って上がるのは着実に、負けて下がるのは少し速い」

---

## 実装変更

### 変更1: 確率テーブル（algorithm.ts:8-12）

homeコートのprob=1.0、他コートのprob=0（ハード除外復活）。
ただし借用フォールバックにより実質的に柔軟。

```typescript
// Before
const COURT_PROBABILITIES_3: Record<RatingGroup, number[]> = {
  upper:  [0.00, 0.50, 0.50],
  middle: [0.25, 0.50, 0.25],
  lower:  [0.50, 0.00, 0.50],
};

// After
const COURT_PROBABILITIES_3: Record<RatingGroup, number[]> = {
  upper:  [1.00, 0.00, 0.00],
  middle: [0.00, 1.00, 0.00],
  lower:  [0.00, 0.00, 1.00],
};
```

### 変更2: assignCourts に借用フォールバックを追加

`selectBestFour` がhomeグループ内で有効な組を見つけられない場合、
隣接グループの序列境界メンバーを1人ずつ候補に追加して再探索する。

```typescript
// 現行のフォールバック（eligible < 4人の場合のみ）
if (eligible.length >= 4) {
  selected = selectBestFour(eligible, ...);
} else {
  // 全activeから探索
}

// 新ロジック: selectBestFourが制約緩和フォールバックを返した場合も借用
selected = selectBestFour(eligible, ...);
if (isConstraintRelaxed(selected, eligible, matchHistory)) {
  // 隣接グループから段階的に候補を追加
  const expanded = expandWithAdjacentPlayers(eligible, courtId, groups, playerOrder);
  selected = selectBestFour(expanded, ...);
}
```

借用の優先順位:
- **C1(upper)**: middle上位 → 1人ずつ追加
- **C2(middle)**: upper下位 + lower上位 → 交互に1人ずつ追加
- **C3(lower)**: middle下位 → 1人ずつ追加

### 変更3: applyStreakSwaps に敗北時の降下を追加（algorithm.ts:79-126）

```typescript
// Before: 敗北時は何もしない
for (const id of losers) {
  streaks.set(id, 0);
}

// After: 敗北時に ceil(groupSize/2) 下がる（2連敗で境界越え）
const groupSize = Math.max(1, Math.floor(order.length / groupCount));
const dropAmount = Math.max(1, Math.ceil(groupSize / 2));

for (const id of losers) {
  streaks.set(id, 0);
  const idx = order.indexOf(id);
  const newIdx = Math.min(order.length - 1, idx + dropAmount);
  if (newIdx > idx) {
    order.splice(idx, 1);
    order.splice(newIdx, 0, id);
  }
}
```

### 変更4: sortWaitingPlayers の調整

homeコートが空いているプレイヤーを上位に表示する。

```typescript
const eligible = emptyCourtIds.some(courtId => {
  const prob = COURT_PROBABILITIES_3[group]?.[courtId - 1] ?? 0;
  return prob >= 0.5;
});
```

### 変更5: hasIsolatedExtreme は維持

借用発生時のスキルバランス保護として引き続き有効。

---

## 影響範囲

| ファイル | 変更内容 | 影響度 |
|---------|---------|--------|
| `src/lib/algorithm.ts` | 確率テーブル変更 | **高** |
| `src/lib/algorithm.ts` | 借用フォールバック追加 | **高** |
| `src/lib/algorithm.ts` | applyStreakSwaps 敗北時降下追加 | **高** |
| `src/lib/algorithm.ts` | sortWaitingPlayers の判定調整 | 中 |
| `src/lib/algorithm.test.ts` | テスト更新 | 中 |

### 変更不要なもの

- `selectBestFour`: 制約チェックは変更なし（候補プールが変わるだけ）
- `formTeams`: チーム編成ロジックは変更なし
- `assign2CourtsHolistic`: 2コート時のロジックは対象外
- `hasIsolatedExtreme`: 引き続き有効
- `getGenderPenalty`: 引き続き有効

---

## リスク・注意点

1. **14-15人での残存デッドロック**: グループサイズ4-5人では借用を加えてもデッドロックが残る（14人:5回、15人:9回）。最終フォールバック（制約無視の上位4人）で対応。
2. **性別3-1率の増加**: 女性3割時に現行0%→22%。ペナルティを強くすれば緩和可能だが、他の最適化とのトレードオフ
3. **人数変動**: 21人ちょうどなら7/7/7。20人なら6/8/6（middleが多い）。端数処理は既存ロジックで対応済み
4. **序列移動のタイミング**: 勝敗で序列が変わると、次ラウンドでグループが変わるプレイヤーが出る。これは望ましい流動性
5. **借用の見た目**: 「なぜこの人がこのコートに？」→「同じ顔ぶれを避けるため、近いレベルの人を1人お借りしました」と説明可能

---

## シミュレーションスクリプト

`scripts/simulate-court-assignment.ts` に検証コードを配置。

```bash
npx tsx scripts/simulate-court-assignment.ts
```
