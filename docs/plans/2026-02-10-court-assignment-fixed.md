# コート配置の固定化 (upper→C1, middle→C2, lower→C3)

**日付**: 2026-02-10
**対象**: `src/lib/algorithm.ts` の確率テーブル・配置ロジック

---

## 背景・課題

### 現状
各グループ（upper/middle/lower）がコートに配置される確率が分散している：

```
         C1    C2    C3
upper:  0.00  0.50  0.50     ← upperはC2/C3のどちらか
middle: 0.25  0.50  0.25     ← middleは全コートに分散
lower:  0.50  0.00  0.50     ← lowerはC1/C3のどちらか
```

**問題**: どのコートに配置されるか予測しにくい。

### 目標
- **upper → C1、middle → C2、lower → C3** にほぼ固定
- 勝利による序列移動で自然な流動性を確保
- 全く同じ顔ぶれでの連続試合は回避
- **最頻出構成**: 3コート、21人

---

## シミュレーション結果

### 1. 7人グループ内のデッドロック問題

21人を3分割すると各グループ7人。7人から4人を連続選出する際、
現行の`hasSimilarRecentMatch`（各個人の直近2試合/3人以上重複禁止）は
**ラウンド6でデッドロック**する。

```
R1: [P1, P2, P3, P4]
R2: [P5, P6, P7, P1]
R3: [P2, P3, P5, P6]
R4: [P4, P7, P2, P5]
R5: [P3, P4, P6, P7]
R6: DEADLOCK（有効な組み合わせなし）
```

**原因**: 7人で直近2試合×3人重複禁止は、全C(7,4)=35通りのうち有効な組が枯渇する。

### 2. パラメータ比較（7人グループ）

| 制約パラメータ | 結果 |
|-------------|------|
| 直近2試合/3人重複（現行） | **デッドロック@R6** |
| 直近1試合/3人重複 | 30ラウンドOK |
| 直近2試合/4人重複 | 30ラウンドOK |
| 直近1試合/4人重複 | 30ラウンドOK |

### 3. 確率テーブル比較（21人、20ラウンド、100回平均）

| 方式 | cross-group | deadlock | 同一連続 |
|------|-----------|----------|---------|
| **現行（分散）** | 183.0回 | 0.0回 | 0.0回 |
| **固定（prob>0）** `[0.90, 0.05, 0.05]` | **12.0回** | **0.0回** | **0.0回** |
| 完全固定（prob=0） `[1.0, 0.0, 0.0]` | 0.0回 | **18.0回** | 0.0回 |
| 完全固定 + 制約緩和（直近1試合） | 0.0回 | 0.0回 | 0.0回 |

### 4. 公平性（20ラウンド後の試合数分布）

| 方式 | min | max | avg | stddev |
|------|-----|-----|-----|--------|
| 現行（分散） | 11 | 12 | 11.4 | 0.49 |
| 完全固定（prob=0） | 8 | 12 | 11.4 | **1.40** |

→ 完全固定はデッドロック時のフォールバックで公平性が悪化。

### 5. 性別パターン別（固定 prob=0.90）

| パターン | MIX率 | 同性率 | 3-1率 | deadlock |
|----------|-------|-------|-------|----------|
| 女性5割(3,4,3) | 75% | 23% | 2% | 0 |
| 女性5割偏り(5,4,1) | 50% | 32% | 18% | 0 |
| 女性3割(2,2,2) | 48% | 30% | 22% | 0 |
| 女性3割偏り(3,2,1) | 45% | 37% | 18% | 0 |
| 女性2割(1,2,1) | 25% | 50% | 25% | 0 |
| 女性2割偏り(0,2,2) | 30% | 53% | 17% | 0 |
| 女性1割(0,1,1) | 12% | 73% | 15% | 0 |

### 6. 確率テーブル × 性別（女性3割/各グループ2人、100回平均）

| 方式 | MIX率 | 同性率 | 3-1率 |
|------|-------|-------|-------|
| 現行（分散） | 51.7% | 48.3% | 0.0% |
| **固定（prob>0）** | **48.3%** | **30.0%** | **21.7%** |
| 完全固定 | 40.0% | 20.0% | 40.0% |

---

## 分析

### 確率テーブルの選択肢

| 選択肢 | 利点 | 欠点 |
|--------|------|------|
| A: `[0.90, 0.05, 0.05]`（推奨） | デッドロック0、コート固定95%、制約変更不要 | cross-group ~5%（12/240） |
| B: `[1.0, 0.0, 0.0]` + 制約緩和（直近1試合） | 完全固定100% | 重複回避が弱い（直近1試合のみ） |
| C: `[1.0, 0.0, 0.0]` + 現行制約 | 完全固定 | デッドロック30%、公平性悪化 |

### 推奨: 選択肢 A

**確率テーブル `[0.90, 0.05, 0.05]`** を採用する理由：

1. **デッドロック0回**: 7人グループでも、隣接グループから1人借りることで必ず有効な組が見つかる
2. **95%固定**: 実質的にはほぼ固定。cross-groupは240配置中12回（5%）程度
3. **制約パラメータ変更不要**: 直近2試合/3人重複禁止を維持（強い重複回避）
4. **公平性維持**: デッドロックがないため、全員均等にプレイ
5. **性別マッチング**: 5%のcross-groupが性別バランス調整のバッファとして機能

### 性別マッチングへの影響

- **女性5割**: 3-1率わずか2%。問題なし
- **女性3割**: 3-1率22%。グループ内の女性が2人だと数学的に3-1が発生しやすい（C(7,4)の57%が3-1構成）。ペナルティで最小化はしているが完全回避は不可
- **女性2割以下**: 同性試合が主体（50-73%）。MIXの機会が限られるのは人数構成上の制約
- **現行との差**: 現行は cross-group による大きなプールから選べるため3-1率0%。固定化すると各グループ7人のプール制限で3-1が増える

**トレードオフ**: コートの予測可能性 vs 性別マッチング品質。prob=0.05のバッファで部分的に緩和される。

---

## 実装変更

### 変更1: 確率テーブル（algorithm.ts:8-12）

```typescript
// Before
const COURT_PROBABILITIES_3: Record<RatingGroup, number[]> = {
  upper:  [0.00, 0.50, 0.50],
  middle: [0.25, 0.50, 0.25],
  lower:  [0.50, 0.00, 0.50],
};

// After
const COURT_PROBABILITIES_3: Record<RatingGroup, number[]> = {
  upper:  [0.90, 0.05, 0.05],
  middle: [0.05, 0.90, 0.05],
  lower:  [0.05, 0.05, 0.90],
};
```

### 変更2: prob=0のハード除外処理

現行の eligible フィルタで `prob === 0` を除外しているが、
新テーブルでは最小 0.05 のため除外は発生しない。
コード変更不要（動作が自然に変わる）。

### 変更3: sortWaitingPlayers の調整（algorithm.ts:658-703）

現行は「空きコートに対して prob > 0 か」で eligible 判定しているが、
新テーブルでは全員 prob > 0 になるため区別がなくなる。

→ 代わりに「主担当コート（prob >= 0.90）が空いているか」で判定する。

```typescript
// 新ロジック: 主担当コートが空きか
const eligible = emptyCourtIds.some(courtId => {
  const prob = COURT_PROBABILITIES_3[group]?.[courtId - 1] ?? 0;
  return prob >= 0.5;  // 主担当コートのprobが高い
});
```

### 変更4: hasIsolatedExtreme は維持

3コート用の孤立制約（upper1人+lower3人 等を禁止）は、
cross-group が発生した際のスキルバランス保護として引き続き有効。

---

## 影響範囲

| ファイル | 変更内容 | 影響度 |
|---------|---------|--------|
| `src/lib/algorithm.ts` | 確率テーブル変更 | **高** |
| `src/lib/algorithm.ts` | sortWaitingPlayers の判定調整 | 中 |
| `src/lib/algorithm.test.ts` | テスト更新 | 中 |

### 変更不要なもの

- `assignCourts` のフロー: そのまま機能する
- `selectBestFour`: 制約チェックは変更なし
- `formTeams`: チーム編成ロジックは変更なし
- `assign2CourtsHolistic`: 2コート時のロジックは対象外
- `hasIsolatedExtreme`: 引き続き有効
- `getGenderPenalty`: 引き続き有効

---

## リスク・注意点

1. **cross-group発生時の見た目**: 95%は固定だが5%で他グループの人が混ざる。ユーザーには「ほぼ固定だが、メンバーの偏りを防ぐため時々移動がある」と説明
2. **性別3-1率の増加**: 女性3割時に現行0%→22%。ペナルティを強くすれば緩和可能だが、他の最適化とのトレードオフ
3. **人数変動**: 21人ちょうどなら7/7/7。20人なら6/8/6（middleが多い）。端数処理は既存ロジックで対応済み
4. **序列移動のタイミング**: 勝敗で序列が変わると、次ラウンドでグループが変わるプレイヤーが出る。これは望ましい流動性

---

## シミュレーションスクリプト

`scripts/simulate-court-assignment.ts` に検証コードを配置。

```bash
npx tsx scripts/simulate-court-assignment.ts
```
