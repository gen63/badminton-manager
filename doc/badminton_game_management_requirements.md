# バドミントンゲーム練習管理システム 要件定義書

## 1. 概要

バドミントンのゲーム練習における、メンバー配置・ゲーム進行・結果記録を円滑に行うためのiPhoneアプリケーション

---

## 2. 基本仕様

### 2.1 想定環境
- **デバイス**: iPhone
- **ネットワーク**: オンライン必須（Firebase リアルタイム同期）
- **ユーザー権限**: 全参加者が全機能を利用可能（管理者権限なし）
- **セッション管理**: URL分離方式
  - 管理者用URL: /session/create
  - 参加者用URL: /session/{sessionId}

### 2.2 参加者規模
- **最大人数**: 30人程度/回
- **コート数**: 1〜3面（変動）

---

## 3. 参加者管理

### 3.1 参加者マスターデータ
- **データソース**: Googleスプレッドシート（任意）
- **取得データ**: レーティング情報のみ
- **データ項目**:
  - 1列目: 名前（ニックネーム）
  - 2列目: レーティング（数値）
- **スプレッドシート接続**:
  - 設定画面でスプレッドシートURLを入力（任意）
  - URL未入力の場合、レーティングは全員未設定
  - 名前が一致する参加者のレーティング情報を自動取得

### 3.2 当日の参加者登録
- **初期設定（練習開始前）**:
  - S01（セッション作成・初期設定画面）で参加者名を改行またはカンマ区切りで一括入力
  - スプレッドシートURLが設定されている場合、名前一致でレーティング情報を取得
  - スプレッドシートに存在しない名前は手動追加可能（レーティング未設定）
  
- **参加者の入室**:
  - 参加者用URLでアプリを開く
  - S02（参加者選択画面）で自分の名前を選択
  - リストに名前がない場合は追加可能
  - 名前選択完了後、S03（メイン画面）へ遷移
  - **選択完了後、他の参加者の画面でその名前がグレーアウト表示**（重複選択防止）
  - **同じ名前の重複登録は不可**（エラー表示）

- **参加者管理画面での追加**:
  - S07（参加者管理画面）でメンバー追加可能
  - スプレッドシートに存在しない場合、レーティング未設定として扱う
  - デフォルトレーティング（1500）を自動付与
  - グルーピング時は中位グループに配置

### 3.3 表示
- **基本表示**: ニックネームを表示
- **レーティング**: 画面上に一切表示しない（心理的安全性のため）
  - 自動配置アルゴリズムでのみ内部的に使用

---

## 4. レーティングシステム

### 4.1 レーティング管理
- **データソース**: Googleスプレッドシート（任意）
- **取得方法**: 名前一致でレーティング情報を取得
- **未設定時の扱い**: 
  - スプレッドシート未使用、またはスプレッドシートに存在しない名前
  - デフォルトレーティング1500を自動付与
  - グルーピング時は中位グループに配置
- **更新**: アプリ内では更新しない（外部で管理）
- **用途**: コート配置とペア編成のバランス調整のみ
- **非表示**: レーティング値は画面に一切表示しない

---

## 5. ゲーム設定

### 5.1 点数設定
- **設定場所**: 設定画面
- **選択肢**:
  - 21点制
  - 15点制
  - フリー（任意の点数）

### 5.2 得点ルール
- **基本**: 21点制または15点制の場合、設定点数以上で勝利
- **デュース**: 2点差が必要（最大30点まで）
- **バリデーション**:
  - 21点制・15点制選択時: どちらかが設定点数未満の場合エラー
  - デュースが想定される場合: 2点差以外はエラー

---

## 6. コート配置とペア編成

### 6.1 自動配置の基本フロー
1. 各コート下の「配置」ボタンをタップ
2. **グルーピング判定**:
   - 全参加者をレーティングでソート
   - **レーティング未設定メンバー**: デフォルトレーティング（1500）を付与し、中位グループに配置
   - コート数に応じてグループ分け:
     - **3コート運用**: 上位4人（1-4位）→上位グループ、下位4人（最下位から4人）→下位グループ、それ以外→中位グループ
     - **2コート運用**: 上位4人→上位グループ、下位4人→下位グループ、それ以外→中位グループ
     - **1コート運用**: グルーピングなし
   - グループとコートの対応:
     - 3コート: 上位G→1,2コート、中位G→全コート、下位G→2,3コート
     - 2コート: 上位G→1コート、中位G→全コート、下位G→2コート
3. **選択可能メンバーの抽出**:
   - 選択したコートに配置可能なグループのメンバーのみを候補とする
   - 休憩中のメンバーは除外
4. **優先度スコアリング**:
   - 各候補者に優先度スコアを計算:
     - 基準値 = 待機時間（最後にプレイ終了してからの経過時間）
     - スコア未入力係数 = 自分が参加した試合でスコア未入力がある場合 0.5、ない場合 1.0
     - 試合数係数 = (平均試合数 - 個人試合数) / 平均試合数 + 1.0
       - 例: 平均3回の時、2回の人は1.33倍、3回の人は1.0倍、4回の人は0.67倍
     - 最終スコア = 基準値 × スコア未入力係数 × 試合数係数
5. **4人選択**:
   - 優先度スコアの高い順に候補者をソート
   - 上位から4人を仮選択
   - 同じ4人の組み合わせが当日3回以上になる場合は、次点の候補者と入れ替え
   - 最終的な4人を確定
6. **ペア編成**:
   - 選択された4人をレーティング順にソート（高→低）
   - **ペアA**: 1位（最強） + 4位（最弱）
   - **ペアB**: 2位 + 3位
7. 選択したコートに配置

### 6.2 コート配置の優先順位
- **原則**: レーティングが高い人ほど、数字の小さいコート（1コート、2コートなど）に入りやすくする
- **方法**: グルーピングによる制約
  - 3コート運用: 上位グループ（レーティング1-4位）は3コートに入れない、下位グループ（最下位4人）は1コートに入れない
  - 2コート運用: 上位グループは2コートに入れない、下位グループは1コートに入れない

### 6.3 配置の制約条件
- **同一組み合わせ回避**: 当日のゲーム練習で同じ4人の組み合わせが3回以上発生しないよう極力避ける
- **ペア制約**: 同じペアの連続は考慮不要（現場で参加者が交代対応）
- **グループ制約**: コート数に応じて、上位・下位グループは特定のコートのみ配置可能
- **待機時間優先**: 待機時間が長い人ほど優先的に選択
- **試合数の公平性**: 試合数が平均より少ない人ほど優先度が上がる（平均試合数基準）
- **スコア未入力ペナルティ**: 自分が参加した試合でスコア未入力がある場合、選択優先度が下がる（係数0.5）

### 6.4 手動調整機能
- **交換方式**: タップ方式
  1. 交換したいメンバー（コート内または待機者）をタップ → 選択状態（背景色変更）
  2. 交換先のメンバーをタップ → 即座に交換実行
  3. 選択中に同じメンバーを再度タップ → 選択解除
- **交換可能範囲**:
  - 待機メンバー ↔ コート内メンバー
  - コート内メンバー ↔ コート内メンバー

### 6.5 休憩機能
- **設定**: 誰でも操作可能（自分・他人問わず）
- **効果**: 休憩中のメンバーは自動配置の対象外
- **用途**: トイレ、水分補給、途中退出など
- **復帰**: 休憩解除も自由に操作可能

---

## 7. ゲーム進行

### 7.1 コート管理
- **コート数**: 1〜3面（画面上で動的に変更可能）
  - コート数増減ボタン（+/−）で変更
  - 最小1、最大3
  - **減少制御**: 使用中のコートがある場合、減少ボタンを無効化（押せない）
    - 例: コート3でゲーム中 → コート数を2に減らすボタンは無効
    - 空きコートのみの場合のみ減少可能
  - コート数変更時、グルーピングが自動的に再計算される

- **コート状態**: 各コートは以下の3つの状態を持つ
  1. **空き**: 配置ボタンのみ表示
  2. **配置済み（開始前）**: クリアボタン + 開始ボタン表示
  3. **ゲーム中**: 半透明オーバーレイ + "ゲーム中" 表示 + 終了ボタン

- **配置フロー**:
  1. 空きコートの「配置」ボタンをタップ
  2. 待機メンバーから4人を自動選択して配置
  3. 必要に応じてメンバー入れ替えで調整
  4. 「開始」ボタンでゲーム開始
  5. 「終了」ボタンで試合ログに記録

- **クリア機能**:
  - 配置済み（開始前）のみ使用可能
  - 4人全員が待機メンバーに戻る
  - コートが空き状態に戻る

- **ゲーム終了時の処理**:
  - 終了時刻を記録
  - 試合時間を計算（終了時刻 - 開始時刻）
  - 試合ログに追加（スコア未入力状態）
  - 4人全員の試合数をカウントアップ（+1）
  - 4人全員が待機メンバーに戻る
  - コートが空き状態に戻る

### 7.2 待機メンバー管理
- 待機中のメンバー一覧を表示
- **表示順**: 試合数の昇順（少ない順）、同数の場合は入室順など
- **試合数表示**: 各メンバーの名前横に括弧付きで試合数を表示（例: "たかし(3)"）
- 休憩中のメンバーは区別して表示
- **スコア未入力表示**: 自分が参加した試合でスコア未入力がある場合、「📝未」アイコンを表示
- ゲーム中でもメンバーのメンバー入れ替えが可能
  - **試合は継続**: 入れ替え後も試合は中断せず継続
  - **試合数カウント**: 入れ替え後の4人が試合終了時に+1
  - **試合時間**: 開始時刻はそのまま（入れ替え時刻は無関係）
  - **試合ログ記録**: 終了時点の4人のみ記録（途中で入れ替わった人は記録されない）
- **待機時間**: 
  - 最後にプレイ終了した時刻から経過時間を内部的に管理（画面表示は不要）
  - 初回参加者（まだ試合をしていない）の待機時間は0
  - 配置アルゴリズムで優先順位判定に使用
- **試合数**: ゲーム終了ボタン押下時にカウントアップ、スコア入力の有無は無関係

---

## 8. セッション管理

### 8.1 セッション作成（管理者）
- **管理者用URL**: `/session/create`
- **フロー**:
  1. 管理者が管理者用URLにアクセス
  2. S00（セッション作成画面）でセッション作成ボタンをタップ
  3. セッションIDを自動生成（例: ABC123）
  4. S01（初回設定画面）へ遷移
  5. 参加者リスト、点数設定などを入力
  6. 参加者用URLを表示
  7. 「次へ」ボタンでS03（メイン画面）へ

### 8.2 参加者の入室
- **参加者用URL**: `/session/{sessionId}`
- **フロー**:
  1. 参加者がURLをタップ（LINEやメールで共有）
  2. S02（参加者選択画面）へ遷移
  3. 自分の名前を選択して入室
  4. S03（メイン画面）へ

### 8.3 通知機能
- **実装方式**: Firebase Cloud Messaging（FCM） + Web Audio API

#### 8.4.1 試合開始通知
**トリガー**: ゲーム開始ボタン押下時
**通知対象**: 配置された4人のメンバー
**通知内容**:
- プッシュ通知: "試合開始 - あなたの試合が始まります！"
- アプリ内音声: 試合開始音（match-start.mp3）

**実装**:
```
1. プッシュ通知送信（FCM）→ スマホロック中でも届く
2. アプリ開いている場合は音声も再生（Web Audio）
```

#### 8.4.2 スコア未入力リマインダー
**トリガー**: 10分間隔で自動チェック
**通知対象**: スコア未入力の試合に参加した4人のメンバー
**通知内容**:
- プッシュ通知: "スコア未入力 - 試合結果を入力してください"

**動作**:
- 試合終了後、10分経過してもスコア未入力の場合に通知
- 以降10分ごとに繰り返し通知
- スコア入力完了で通知停止

### 8.4 練習リセット機能
- **目的**: 同じセッション・参加者リストで新しい練習を開始
- **場所**: S05（設定画面）の「セッション管理」セクション

#### 8.4.1 リセット操作
1. 「練習をリセット」ボタンをタップ
2. 確認ダイアログ表示
   - **ログを保存してリセット**: 本日のログを日時付きでアーカイブ、後から閲覧可能（将来実装）
   - **ログを削除してリセット**: ログを完全削除
   - **キャンセル**: リセット中止

#### 8.4.2 リセット時の動作
**リセットされるデータ**:
- 全員の試合数を0にリセット
- 待機時間をリセット
- スコア未入力状態をクリア
- 全コートを空き状態に
- 全員を待機メンバーに移動
- 休憩状態を解除
- 試合ログ（ログ削除を選択した場合）

**保持されるデータ**:
- 参加者リスト
- レーティング情報
- セッションID・参加者用URL
- 点数設定
- コート数

#### 8.4.3 リセット後
- 参加者の再入室は不要
- 全員が同じセッションで継続
- メイン画面に戻り、新しい練習を開始可能

### 8.5 履歴コピー機能
- **目的**: 試合ログをテキストとしてクリップボードにコピー
- **場所**: S05（設定画面）の「セッション管理」セクション

#### 8.5.1 コピー操作
1. 「履歴をコピー」ボタンをタップ
2. スコア入力済みの試合のみをタブ区切り形式でコピー

#### 8.5.2 コピーフォーマット
```
2026/01/28 14:30

連番	ペアA	ペアB	スコア	時刻	試合時間
1	たかし・ゆうこ	けんた・まい	21-15	14:00	12分
2	ひろし・さき	だいき・りょう	18-21	14:15	15分
3	なお・まさる	あい・ゆき	21-19	14:30	13分
```

**形式詳細**:
- 1行目: 日付（YYYY/MM/DD HH:MM形式）
- 2行目: 空行
- 3行目: ヘッダー行（タブ区切り）
- 4行目以降: データ行（タブ区切り）
- スコア未入力の試合は含まない

#### 8.5.3 コピー後
- 「コピーしました」とトースト通知表示
- Excelやスプレッドシートに貼り付け可能

---

## 9. スコア入力と記録

### 12.1 入力方法
- **入力者**: 試合をした4人のうち1人が代表して入力
- **承認**: 初期バージョンでは不要（将来的に検討）
- **UI**: 0〜30のボタンを配置、タップで点数を順次入力
  - 例: 「21」→「15」とタップ → ペアAが21-15で勝利
  - デュースも同様（例: 「22」→「20」）
- **確定**: 入力完了後、確定ボタンで記録

### 12.2 バリデーション
- 設定した点数制に応じてエラーチェック
- エラー時はメッセージ表示し再入力を促す

### 12.3 記録内容
- **基本情報**:
  - 連番（通し番号）
  - 開始時刻（ゲーム開始ボタン押下時）
  - 終了時刻（ゲーム終了ボタン押下時）
  - 試合時間（終了時刻 - 開始時刻、分単位）
  - コート番号
  - ペアA・ペアBのメンバー（各2名）
  - スコア
  - 勝敗
- **保存**: デバイス内にローカル保存（オフライン対応）
- **表示**: メイン画面下部に最大100件のログを表示
  - 最新の試合が上に表示
  - 各ログにスコア入力/修正ボタンを配置
  - ログは折りたたみ可能（ただし未入力かつ自分が参加した試合は常時表示）

### 12.4 記録の活用
- メイン画面でリアルタイムに試合履歴を確認可能
- 個人成績（勝率、参加回数など）の集計も将来的に検討

---

## 10. 画面構成（想定）

### 12.1 メイン画面
- コート状況（各コートの試合状況を3状態で管理）
  - 空き / 配置済み（開始前） / ゲーム中
- 各コート下に状態に応じたボタン
  - 空き: 配置ボタン
  - 配置済み: クリアボタン + 開始ボタン
  - ゲーム中: 終了ボタン
- ゲーム中の視覚的表示（半透明オーバーレイ + "ゲーム中" テキスト）
- 待機メンバー一覧
- 休憩中メンバー一覧
- 試合ログ（最大100件、折りたたみ可能）
  - 連番、プレイヤー、時刻、入力/修正ボタン
- メンバー入れ替え機能（タップ方式、ゲーム中も可能）

### 12.2 スコア入力画面
- 0〜30の点数ボタン
- ペアA・ペアB表示
- 入力履歴表示
- 確定ボタン

### 12.3 設定画面
- Googleスプレッドシート URL入力（任意）
- 点数設定（21点/15点/フリー）
- 参加者管理へのリンク

### 12.4 参加者選択画面
- ニックネーム一覧から選択（選択済みは非表示）
- 名前追加機能

### 12.5 参加者管理画面
- 参加者一覧（グリッド表示、横並び3列程度で折り返し）
- 各メンバーのすぐ隣に削除ボタン配置
- メンバー追加欄（名前入力 + 追加ボタン）

---

## 11. 技術要件

### 11.1 技術スタック
- **フロントエンド**: React（Web）またはReact Native（iOS）
- **バックエンド**: Firebase
  - **Firestore**: リアルタイムデータベース
  - **Authentication**: Anonymous Auth（匿名認証）
  - **Cloud Messaging (FCM)**: プッシュ通知
  - **Hosting**: Webホスティング

### 11.2 認証とセッション管理
- **認証方式**: Firebase Anonymous Authentication
  - 初回アクセス時に匿名ユーザーID自動発行
  - 名前選択後、ユーザーIDと名前を紐付け
  - リロードしても同じユーザーとして認識
  - 複数デバイス対応なし（1人1デバイス）
- **セッション管理**:
  - セッションIDでFirestoreのデータを分離
  - 48時間アクセスなしで自動削除（Cloud Functionsで実装）

### 11.3 リアルタイム同期
- **Firestoreリアルタイムリスナー**で全参加者の画面を同期
- **常時監視**: config, players, courts（即座に反映が必要なデータ）
- **最新データのみ監視**: matches（最新10件のみリスナー、残りはページング取得）
- コート状態、待機メンバー、試合ログが自動更新
- オンライン必須（オフライン時は閲覧のみ可能）

### 11.4 データ永続化
- Firestoreに全データを保存
- セッションIDベースでデータ管理
- 48時間アクセスなしで自動削除（Cloud Functionsで実装）
- 手動削除も可能（練習リセット機能）

### 11.5 Firestore構造
```javascript
sessions/{sessionId}/
  ├─ config/
  │   ├─ scoreType: "21" | "15" | "free"
  │   ├─ courtCount: number (1-3)
  │   ├─ createdAt: timestamp
  │   ├─ lastAccessAt: timestamp
  │   └─ spreadsheetUrl?: string
  │
  ├─ players/{playerId}/  // playerIdはAnonymous Auth UID
  │   ├─ name: string
  │   ├─ rating: number (デフォルト1500)
  │   ├─ matchCount: number
  │   ├─ lastFinishTime: timestamp | null
  │   ├─ hasUnscoredMatch: boolean
  │   ├─ isResting: boolean
  │   ├─ fcmToken?: string  // 最新デバイスのトークンのみ
  │   └─ joinedAt: timestamp
  │
  ├─ courts/{courtId}/  // courtId: "court1", "court2", "court3"
  │   ├─ status: "empty" | "ready" | "playing"
  │   ├─ playerIds: string[] (4人)
  │   ├─ startTime?: timestamp
  │   └─ pairA: string[] (2人)
  │
  ├─ matches/{matchId}/
  │   ├─ matchNumber: number
  │   ├─ courtId: string
  │   ├─ playerIds: string[] (終了時点の4人)
  │   ├─ pairA: string[]
  │   ├─ pairB: string[]
  │   ├─ score?: string
  │   ├─ startTime: timestamp
  │   ├─ endTime?: timestamp
  │   └─ duration?: number (分単位)
  │
  └─ userPreferences/{userId}/
      └─ hiddenMatchIds: string[]  // 個人ごとの非表示設定
```

### 11.6 通知システム
- **FCM（Firebase Cloud Messaging）**: プッシュ通知
- **Web Audio API**: アプリ内音声再生
- **FCMトークン管理**:
  - 取得タイミング: 名前選択後（S02完了時）
  - 保存場所: `players/{playerId}/fcmToken`
  - 複数デバイス対応なし（最新デバイスのトークンで上書き）
- **通知タイミング**:
  - 試合開始時: 配置された4人に即座通知
  - スコア未入力: 10分間隔でリマインダー

### 11.7 状態管理
- **待機時間**: 各メンバーの最後のプレイ終了時刻を記録
- **試合数**: 各メンバーの当日の試合数をカウント（終了ボタン押下時に+1）
- **平均試合数**: 全参加者の試合数から平均を計算し、試合数係数の算出に使用
- **スコア未入力状態**: 各メンバーが参加した試合のうち、スコア未入力の試合があるかを管理
- **グルーピング**: 参加者数とコート数に応じて動的にグループを計算
- **組み合わせ履歴**: 当日の4人組み合わせを記録し、3回以上の重複をチェック

### 11.8 エラーハンドリング
- **ネットワークエラー**: 
  - トースト通知「接続エラーが発生しました。再試行してください」
  - 自動リトライ（3回まで）
- **Firebaseエラー**:
  - 権限エラー: 「アクセス権限がありません」
  - データ不整合: ローカル状態とFirestoreを再同期
- **UI制御**:
  - ボタン無効化時は非表示
  - ローディング表示は基本不要（重い処理が発生した場合のみ検討）

---

## 12. 将来的な拡張機能

### 12.1 承認機能
- スコア入力後、対戦相手による承認フロー

### 12.2 統計・分析
- 個人成績の詳細分析（勝率、対戦相手別成績など）
- チーム全体の傾向分析

### 12.3 通知機能
- 次のゲームへの呼び出し通知
- 休憩時間のリマインダー

### 12.4 複数デバイス同期
- 複数のiPhoneで同時利用・データ同期

---

## 13. 運用上の注意点

### 12.1 参加者の自律性
- 休憩設定は周囲のメンバーが協力して管理
- スコア入力は代表者が責任を持って実施

### 12.2 柔軟な対応
- ペア編成は現場で柔軟に調整可能（メンバー入れ替え機能）
- システムはあくまで補助ツールとして位置づけ

---

## 14. まとめ

本システムは、バドミントンのゲーム練習における煩雑な管理業務を効率化し、参加者全員が円滑に楽しく練習できる環境を提供することを目的とする。レーティングに基づく自動配置と手動調整のバランスを取り、オフライン環境でも安定して動作する設計とする。

---

**作成日**: 2026年1月28日  
**バージョン**: 1.0
