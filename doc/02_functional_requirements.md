# バドミントンゲーム練習管理システム - 機能要件

## 目次
- [1. 参加者管理](#1-参加者管理)
- [2. レーティングシステム](#2-レーティングシステム)
- [3. ゲーム設定](#3-ゲーム設定)
- [4. コート配置とペア編成](#4-コート配置とペア編成)
- [5. ゲーム進行](#5-ゲーム進行)
- [6. スコア入力と記録](#6-スコア入力と記録)

---

## 1. 参加者管理

### 1.1 参加者マスターデータ
- **データソース**: Googleスプレッドシート（任意）
- **取得データ**: レーティング情報のみ
- **データ項目**:
  - 1列目: 名前（ニックネーム）
  - 2列目: レーティング（数値）
- **スプレッドシート接続**:
  - 設定画面でスプレッドシートURLを入力（任意）
  - URL未入力の場合、レーティングは全員未設定
  - 名前が一致する参加者のレーティング情報を自動取得

### 1.2 当日の参加者登録
- **初期設定（練習開始前）**:
  - S01（セッション作成・初期設定画面）で参加者名を改行またはカンマ区切りで一括入力
  - スプレッドシートURLが設定されている場合、名前一致でレーティング情報を取得
  - スプレッドシートに存在しない名前は手動追加可能（レーティング未設定）
  
- **参加者の入室**:
  - 参加者用URLでアプリを開く
  - S02（参加者選択画面）で自分の名前を選択
  - リストに名前がない場合は追加可能
  - 名前選択完了後、S03（メイン画面）へ遷移
  - **選択完了後、他の参加者の画面でその名前がグレーアウト表示**（重複選択防止）
  - **同じ名前の重複登録は不可**（エラー表示）

- **参加者管理画面での追加**:
  - S07（参加者管理画面）でメンバー追加可能
  - スプレッドシートに存在しない場合、レーティング未設定として扱う
  - デフォルトレーティング（1500）を自動付与
  - グルーピング時は中位グループに配置

### 1.3 表示
- **基本表示**: ニックネームを表示
- **レーティング**: 画面上に一切表示しない（心理的安全性のため）
  - 自動配置アルゴリズムでのみ内部的に使用

---

## 2. レーティングシステム

### 2.1 レーティング管理
- **データソース**: Googleスプレッドシート（任意）
- **取得方法**: 名前一致でレーティング情報を取得
- **未設定時の扱い**: 
  - スプレッドシート未使用、またはスプレッドシートに存在しない名前
  - デフォルトレーティング1500を自動付与
  - グルーピング時は中位グループに配置
- **更新**: アプリ内では更新しない（外部で管理）
- **用途**: コート配置とペア編成のバランス調整のみ
- **非表示**: レーティング値は画面に一切表示しない

---

## 3. ゲーム設定

### 3.1 点数設定
- **設定場所**: 設定画面
- **選択肢**:
  - 21点制
  - 15点制
  - フリー（任意の点数）

### 3.2 得点ルール
- **基本**: 21点制または15点制の場合、設定点数以上で勝利
- **デュース**: 2点差が必要（最大30点まで）
- **バリデーション**:
  - 21点制・15点制選択時: どちらかが設定点数未満の場合エラー
  - デュースが想定される場合: 2点差以外はエラー

---

## 4. コート配置とペア編成

### 4.1 自動配置の基本フロー
1. 各コート下の「配置」ボタンをタップ
2. **グルーピング判定**:
   - 全参加者をレーティングでソート
   - **レーティング未設定メンバー**: デフォルトレーティング（1500）を付与し、中位グループに配置
   - コート数に応じてグループ分け:
     - **3コート運用**: 上位4人（1-4位）→上位グループ、下位4人（最下位から4人）→下位グループ、それ以外→中位グループ
     - **2コート運用**: 上位4人→上位グループ、下位4人→下位グループ、それ以外→中位グループ
     - **1コート運用**: グルーピングなし
   - グループとコートの対応:
     - 3コート: 上位G→1,2コート、中位G→全コート、下位G→2,3コート
     - 2コート: 上位G→1コート、中位G→全コート、下位G→2コート
3. **選択可能メンバーの抽出**:
   - 選択したコートに配置可能なグループのメンバーのみを候補とする
   - 休憩中のメンバーは除外
4. **優先度スコアリング**:
   - 各候補者に優先度スコアを計算:
     - 基準値 = 待機時間（最後にプレイ終了してからの経過時間）
     - スコア未入力係数 = 自分が参加した試合でスコア未入力がある場合 0.5、ない場合 1.0
     - 試合数係数 = (平均試合数 - 個人試合数) / 平均試合数 + 1.0
       - 例: 平均3回の時、2回の人は1.33倍、3回の人は1.0倍、4回の人は0.67倍
     - 最終スコア = 基準値 × スコア未入力係数 × 試合数係数
5. **4人選択**:
   - 優先度スコアの高い順に候補者をソート
   - 上位から4人を仮選択
   - 同じ4人の組み合わせが当日3回以上になる場合は、次点の候補者と入れ替え
   - 最終的な4人を確定
6. **ペア編成**:
   - 選択された4人をレーティング順にソート（高→低）
   - **ペアA**: 1位（最強） + 4位（最弱）
   - **ペアB**: 2位 + 3位
7. 選択したコートに配置

### 4.2 コート配置の優先順位
- **原則**: レーティングが高い人ほど、数字の小さいコート（1コート、2コートなど）に入りやすくする
- **方法**: グルーピングによる制約
  - 3コート運用: 上位グループ（レーティング1-4位）は3コートに入れない、下位グループ（最下位4人）は1コートに入れない
  - 2コート運用: 上位グループは2コートに入れない、下位グループは1コートに入れない

### 4.3 配置の制約条件
- **同一組み合わせ回避**: 当日のゲーム練習で同じ4人の組み合わせが3回以上発生しないよう極力避ける
- **ペア制約**: 同じペアの連続は考慮不要（現場で参加者が交代対応）
- **グループ制約**: コート数に応じて、上位・下位グループは特定のコートのみ配置可能
- **待機時間優先**: 待機時間が長い人ほど優先的に選択
- **試合数の公平性**: 試合数が平均より少ない人ほど優先度が上がる（平均試合数基準）
- **スコア未入力ペナルティ**: 自分が参加した試合でスコア未入力がある場合、選択優先度が下がる（係数0.5）

### 4.4 手動調整機能
- **交換方式**: タップ方式
  1. 交換したいメンバー（コート内または待機者）をタップ → 選択状態（背景色変更）
  2. 交換先のメンバーをタップ → 即座に交換実行
  3. 選択中に同じメンバーを再度タップ → 選択解除
- **交換可能範囲**:
  - 待機メンバー ↔ コート内メンバー
  - コート内メンバー ↔ コート内メンバー

### 4.5 休憩機能
- **設定**: 誰でも操作可能（自分・他人問わず）
- **効果**: 休憩中のメンバーは自動配置の対象外
- **用途**: トイレ、水分補給、途中退出など
- **復帰**: 休憩解除も自由に操作可能

---

## 5. ゲーム進行

### 5.1 コート管理
- **コート数**: 1〜3面（画面上で動的に変更可能）
  - コート数増減ボタン（+/−）で変更
  - 最小1、最大3
  - **減少制御**: 使用中のコートがある場合、減少ボタンを非表示
    - 例: コート3でゲーム中 → コート数を2に減らすボタンは非表示
    - 空きコートのみの場合のみ減少可能
  - コート番号は常に1から順番（減少時はコート3→2→1の順で削除）
  - コート数変更時、グルーピングが自動的に再計算される

- **コート状態**: 各コートは以下の3つの状態を持つ
  1. **空き**: 配置ボタンのみ表示
  2. **配置済み（開始前）**: クリアボタン + 開始ボタン表示
  3. **ゲーム中**: 半透明オーバーレイ + "ゲーム中" 表示 + 終了ボタン

- **配置フロー**:
  1. 空きコートの「配置」ボタンをタップ
  2. 待機メンバーから4人を自動選択して配置
  3. 必要に応じてメンバー入れ替えで調整
  4. 「開始」ボタンでゲーム開始
  5. 「終了」ボタンで試合ログに記録

- **クリア機能**:
  - 配置済み（開始前）のみ使用可能
  - 4人全員が待機メンバーに戻る
  - コートが空き状態に戻る

- **ゲーム終了時の処理**:
  - 終了時刻を記録
  - 試合時間を計算（終了時刻 - 開始時刻）
  - 試合ログに追加（スコア未入力状態）
  - 4人全員の試合数をカウントアップ（+1）
  - 4人全員が待機メンバーに戻る
  - コートが空き状態に戻る

### 5.2 待機メンバー管理
- 待機中のメンバー一覧を表示
- **表示順**: 試合数の昇順（少ない順）、同数の場合は入室順など
- **試合数表示**: 各メンバーの名前横に括弧付きで試合数を表示（例: "たかし(3)"）
- 休憩中のメンバーは区別して表示
- **スコア未入力表示**: 自分が参加した試合でスコア未入力がある場合、「📝未」アイコンを表示
- ゲーム中でもメンバーのメンバー入れ替えが可能
  - **試合は継続**: 入れ替え後も試合は中断せず継続
  - **試合数カウント**: 入れ替え後の4人が試合終了時に+1
  - **試合時間**: 開始時刻はそのまま（入れ替え時刻は無関係）
  - **試合ログ記録**: 終了時点の4人のみ記録（途中で入れ替わった人は記録されない）
- **待機時間**: 
  - 最後にプレイ終了した時刻から経過時間を内部的に管理（画面表示は不要）
  - 初回参加者（まだ試合をしていない）の待機時間は0
  - 配置アルゴリズムで優先順位判定に使用
- **試合数**: ゲーム終了ボタン押下時にカウントアップ、スコア入力の有無は無関係

---

## 6. スコア入力と記録

### 6.1 入力方法
- **入力者**: 全参加者（誰でも入力・修正可能）
- **入力タイミング**: 試合終了後いつでも
- **UI**: 0〜30のボタンを配置、タップで点数を順次入力
  - 例: 「21」→「15」とタップ → ペアAが21-15で勝利
  - デュースも同様（例: 「22」→「20」）
- **確定**: 入力完了後、確定ボタンで記録

### 6.2 バリデーション
- 設定した点数制に応じてエラーチェック
- エラー時はメッセージ表示し再入力を促す

### 6.3 記録内容
- **基本情報**:
  - 連番（通し番号）
  - 開始時刻（ゲーム開始ボタン押下時）
  - 終了時刻（ゲーム終了ボタン押下時）
  - 試合時間（終了時刻 - 開始時刻、分単位）
  - コート番号
  - ペアA・ペアBのメンバー（各2名）
  - スコア

### 6.4 記録の活用
- 試合ログ画面に一覧表示
- スコア未入力の試合は「入力」ボタン表示
- スコア入力済みの試合は「修正」ボタン表示
- **個人ごとの表示制御**:
  - スコア入力済み かつ 自分が不参加の試合は非表示可能（個人ごとに設定）
  - スコア未入力 または 自分が参加した試合は常に表示

---

## 関連ドキュメント

- [01_overview.md](./01_overview.md) - 概要
- [03_session_and_notification.md](./03_session_and_notification.md) - セッション・通知
- [04_technical_spec.md](./04_technical_spec.md) - 技術仕様
- [05_screen_design.md](./05_screen_design.md) - 画面設計

---

**作成日**: 2026/01/29  
**最終更新**: 2026/01/29
